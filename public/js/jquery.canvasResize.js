/*
 * jQuery canvasResize plugin
 * 
 * Version: 1.2.0 
 * Date (d/m/y): 02/10/12
 * Update (d/m/y): 14/05/13
 * Original author: @gokercebeci 
 * Licensed under the MIT license
 *
 */
 (function(d){var c="canvasResize",a={newsize:function(g,j,f,i,l){var m=l?"h":"";if((f&&g>f)||(i&&j>i)){var k=g/j;if((k>=1||i===0)&&f&&!l){g=f;j=(f/k)>>0}else{if(l&&k<=(f/i)){g=f;j=(f/k)>>0;m="w"}else{g=(i*k)>>0;j=i}}}return{width:g,height:j,cropped:m}},dataURLtoBlob:function(k){var f=k.split(",")[0].split(":")[1].split(";")[0];var m=atob(k.split(",")[1]);var j=new ArrayBuffer(m.length);var g=new Uint8Array(j);for(var h=0;h<m.length;h++){g[h]=m.charCodeAt(h)}var l=(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);if(l){l=new (window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder)();l.append(j);return l.getBlob(f)}else{l=new Blob([j],{type:(f)});return l}},detectSubsampling:function(h){var g=h.width,j=h.height;if(g*j>1048576){var i=document.createElement("canvas");i.width=i.height=1;var f=i.getContext("2d");f.drawImage(h,-g+1,0);return f.getImageData(0,0,1,1).data[3]===0}else{return false}},rotate:function(f,h){var g={1:{90:6,180:3,270:8},2:{90:7,180:4,270:5},3:{90:8,180:1,270:6},4:{90:5,180:2,270:7},5:{90:2,180:7,270:4},6:{90:3,180:8,270:1},7:{90:4,180:5,270:2},8:{90:1,180:6,270:3}};return g[f][h]?g[f][h]:f},transformCoordinate:function(i,j,f,h){switch(h){case 5:case 6:case 7:case 8:i.width=f;i.height=j;break;default:i.width=j;i.height=f}var g=i.getContext("2d");switch(h){case 1:break;case 2:g.translate(j,0);g.scale(-1,1);break;case 3:g.translate(j,f);g.rotate(Math.PI);break;case 4:g.translate(0,f);g.scale(1,-1);break;case 5:g.rotate(0.5*Math.PI);g.scale(1,-1);break;case 6:g.rotate(0.5*Math.PI);g.translate(0,-f);break;case 7:g.rotate(0.5*Math.PI);g.translate(j,-f);g.scale(-1,1);break;case 8:g.rotate(-0.5*Math.PI);g.translate(-j,0);break;default:break}},detectVerticalSquash:function(j,g,o){var f=document.createElement("canvas");f.width=1;f.height=o;var p=f.getContext("2d");p.drawImage(j,0,0);var i=p.getImageData(0,0,1,o).data;var m=0;var k=o;var n=o;while(n>m){var h=i[(n-1)*4+3];if(h===0){k=n}else{m=n}n=(k+m)>>1}var l=n/o;return l===0?1:l},callback:function(f){return f}},e={width:300,height:0,crop:false,quality:80,callback:a.callback};function b(g,f){this.file=g;this.options=d.extend({},e,f);this._defaults=e;this._name=c;this.init()}b.prototype={init:function(){var h=this;var g=this.file;var f=new FileReader();f.onloadend=function(j){var k=j.target.result;var i=new Image();i.onload=function(l){d(i).exifLoadFromDataURL(function(){var o=d(i).exif("Orientation")[0]||1;o=a.rotate(o,h.options.rotate);var B=(o>=5&&o<=8)?a.newsize(i.height,i.width,h.options.width,h.options.height,h.options.crop):a.newsize(i.width,i.height,h.options.width,h.options.height,h.options.crop);var q=i.width,z=i.height;var F=B.width,C=B.height;var n=document.createElement("canvas");var G=n.getContext("2d");G.save();a.transformCoordinate(n,F,C,o);if(a.detectSubsampling(i)){q/=2;z/=2}var J=1024;var m=document.createElement("canvas");m.width=m.height=J;var p=m.getContext("2d");var H=a.detectVerticalSquash(i,q,z);var A=0;while(A<z){var K=A+J>z?z-A:J;var D=0;while(D<q){var E=D+J>q?q-D:J;p.clearRect(0,0,J,J);p.drawImage(i,-D,-A);var v=Math.floor(D*F/q);var w=Math.ceil(E*F/q);var u=Math.floor(A*C/z/H);var I=Math.ceil(K*C/z/H);G.drawImage(m,0,0,E,K,v,u,w,I);D+=J}A+=J}G.restore();m=p=null;var r=document.createElement("canvas");r.width=B.cropped==="h"?C:F;r.height=B.cropped==="w"?F:C;var t=B.cropped==="h"?(C-F)*0.5:0;var s=B.cropped==="w"?(F-C)*0.5:0;newctx=r.getContext("2d");newctx.drawImage(n,t,s,F,C);if(g.type==="image/png"){var L=r.toDataURL(g.type)}else{var L=r.toDataURL("image/jpeg",(h.options.quality*0.01))}h.options.callback(L,F,C)})};i.src=k};f.readAsDataURL(g)}};d[c]=function(g,f){if(typeof g==="string"){return a[g](f)}else{new b(g,f)}}})(jQuery);
/*
 * Javascript EXIF Reader - jQuery plugin 0.1.3
 * Copyright (c) 2008 Jacob Seidelin, cupboy@gmail.com, http://blog.nihilogic.dk/
 * Licensed under the MPL License [http://www.nihilogic.dk/licenses/mpl-license.txt]
 */

/*
 * I added three functions for read EXIF from dataURL
 * - getImageDataFromDataURL
 * - getDataFromDataURL
 * - jQuery.fn.exifLoadFromDataURL
 * 
 * http://orientation.gokercebeci.com 
 * @gokercebeci
 */
 (function(){var b=function(i,f,e){var g=i;var d=f||0;var h=0;this.getRawData=function(){return g};if(typeof i=="string"){h=e||g.length;this.getByteAt=function(j){return g.charCodeAt(j+d)&255}}else{if(typeof i=="unknown"){h=e||IEBinary_getLength(g);this.getByteAt=function(j){return IEBinary_getByteAt(g,j+d)}}}this.getLength=function(){return h};this.getSByteAt=function(k){var j=this.getByteAt(k);if(j>127){return j-256}else{return j}};this.getShortAt=function(l,j){var k=j?(this.getByteAt(l)<<8)+this.getByteAt(l+1):(this.getByteAt(l+1)<<8)+this.getByteAt(l);if(k<0){k+=65536}return k};this.getSShortAt=function(l,k){var j=this.getShortAt(l,k);if(j>32767){return j-65536}else{return j}};this.getLongAt=function(o,k){var n=this.getByteAt(o),m=this.getByteAt(o+1),l=this.getByteAt(o+2),j=this.getByteAt(o+3);var p=k?(((((n<<8)+m)<<8)+l)<<8)+j:(((((j<<8)+l)<<8)+m)<<8)+n;if(p<0){p+=4294967296}return p};this.getSLongAt=function(l,j){var k=this.getLongAt(l,j);if(k>2147483647){return k-4294967296}else{return k}};this.getStringAt=function(o,n){var k=[];for(var m=o,l=0;m<o+n;m++,l++){k[l]=String.fromCharCode(this.getByteAt(m))}return k.join("")};this.getCharAt=function(j){return String.fromCharCode(this.getByteAt(j))};this.toBase64=function(){return window.btoa(g)};this.fromBase64=function(j){g=window.atob(j)}};var c=(function(){function e(){var g=null;if(window.XMLHttpRequest){g=new XMLHttpRequest()}else{if(window.ActiveXObject){g=new ActiveXObject("Microsoft.XMLHTTP")}}return g}function f(j,g,i){var h=e();if(h){if(g){if(typeof(h.onload)!="undefined"){h.onload=function(){if(h.status=="200"){g(this)}else{if(i){i()}}h=null}}else{h.onreadystatechange=function(){if(h.readyState==4){if(h.status=="200"){g(this)}else{if(i){i()}}h=null}}}}h.open("HEAD",j,true);h.send(null)}else{if(i){i()}}}function d(h,k,j,g,l,m){var i=e();if(i){var n=0;if(g&&!l){n=g[0]}var o=0;if(g){o=g[1]-g[0]+1}if(k){if(typeof(i.onload)!="undefined"){i.onload=function(){if(i.status=="200"||i.status=="206"||i.status=="0"){this.binaryResponse=new b(this.responseText,n,o);this.fileSize=m||this.getResponseHeader("Content-Length");k(this)}else{if(j){j()}}i=null}}else{i.onreadystatechange=function(){if(i.readyState==4){if(i.status=="200"||i.status=="206"||i.status=="0"){this.binaryResponse=new b(i.responseBody,n,o);this.fileSize=m||this.getResponseHeader("Content-Length");k(this)}else{if(j){j()}}i=null}}}}i.open("GET",h,true);if(i.overrideMimeType){i.overrideMimeType("text/plain; charset=x-user-defined")}if(g&&l){i.setRequestHeader("Range","bytes="+g[0]+"-"+g[1])}i.setRequestHeader("If-Modified-Since","Sat, 1 Jan 1970 00:00:00 GMT");i.send(null)}else{if(j){j()}}}return function(j,g,i,h){if(h){f(j,function(m){var o=parseInt(m.getResponseHeader("Content-Length"),10);var n=m.getResponseHeader("Accept-Ranges");var l,k;l=h[0];if(h[0]<0){l+=o}k=l+h[1]-1;d(j,g,i,[l,k],(n=="bytes"),o)})}else{d(j,g,i)}}}());document.write("<script type='text/vbscript'>\r\nFunction IEBinary_getByteAt(strBinary, iOffset)\r\n	IEBinary_getByteAt = AscB(MidB(strBinary,iOffset+1,1))\r\nEnd Function\r\nFunction IEBinary_getLength(strBinary)\r\n	IEBinary_getLength = LenB(strBinary)\r\nEnd Function\r\n<\/script>\r\n");var a={};(function(){var l=false;a.Tags={36864:"ExifVersion",40960:"FlashpixVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",37121:"ComponentsConfiguration",37122:"CompressedBitsPerPixel",37500:"MakerNote",37510:"UserComment",40964:"RelatedSoundFile",36867:"DateTimeOriginal",36868:"DateTimeDigitized",37520:"SubsecTime",37521:"SubsecTimeOriginal",37522:"SubsecTimeDigitized",33434:"ExposureTime",33437:"FNumber",34850:"ExposureProgram",34852:"SpectralSensitivity",34855:"ISOSpeedRatings",34856:"OECF",37377:"ShutterSpeedValue",37378:"ApertureValue",37379:"BrightnessValue",37380:"ExposureBias",37381:"MaxApertureValue",37382:"SubjectDistance",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37396:"SubjectArea",37386:"FocalLength",41483:"FlashEnergy",41484:"SpatialFrequencyResponse",41486:"FocalPlaneXResolution",41487:"FocalPlaneYResolution",41488:"FocalPlaneResolutionUnit",41492:"SubjectLocation",41493:"ExposureIndex",41495:"SensingMethod",41728:"FileSource",41729:"SceneType",41730:"CFAPattern",41985:"CustomRendered",41986:"ExposureMode",41987:"WhiteBalance",41988:"DigitalZoomRation",41989:"FocalLengthIn35mmFilm",41990:"SceneCaptureType",41991:"GainControl",41992:"Contrast",41993:"Saturation",41994:"Sharpness",41995:"DeviceSettingDescription",41996:"SubjectDistanceRange",40965:"InteroperabilityIFDPointer",42016:"ImageUniqueID"};a.TiffTags={256:"ImageWidth",257:"ImageHeight",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer",40965:"InteroperabilityIFDPointer",258:"BitsPerSample",259:"Compression",262:"PhotometricInterpretation",274:"Orientation",277:"SamplesPerPixel",284:"PlanarConfiguration",530:"YCbCrSubSampling",531:"YCbCrPositioning",282:"XResolution",283:"YResolution",296:"ResolutionUnit",273:"StripOffsets",278:"RowsPerStrip",279:"StripByteCounts",513:"JPEGInterchangeFormat",514:"JPEGInterchangeFormatLength",301:"TransferFunction",318:"WhitePoint",319:"PrimaryChromaticities",529:"YCbCrCoefficients",532:"ReferenceBlackWhite",306:"DateTime",270:"ImageDescription",271:"Make",272:"Model",305:"Software",315:"Artist",33432:"Copyright"};a.GPSTags={0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude",5:"GPSAltitudeRef",6:"GPSAltitude",7:"GPSTimeStamp",8:"GPSSatellites",9:"GPSStatus",10:"GPSMeasureMode",11:"GPSDOP",12:"GPSSpeedRef",13:"GPSSpeed",14:"GPSTrackRef",15:"GPSTrack",16:"GPSImgDirectionRef",17:"GPSImgDirection",18:"GPSMapDatum",19:"GPSDestLatitudeRef",20:"GPSDestLatitude",21:"GPSDestLongitudeRef",22:"GPSDestLongitude",23:"GPSDestBearingRef",24:"GPSDestBearing",25:"GPSDestDistanceRef",26:"GPSDestDistance",27:"GPSProcessingMethod",28:"GPSAreaInformation",29:"GPSDateStamp",30:"GPSDifferential"};a.StringValues={ExposureProgram:{0:"Not defined",1:"Manual",2:"Normal program",3:"Aperture priority",4:"Shutter priority",5:"Creative program",6:"Action program",7:"Portrait mode",8:"Landscape mode"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{0:"Unknown",1:"Daylight",2:"Fluorescent",3:"Tungsten (incandescent light)",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 - 5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire",1:"Flash fired",5:"Strobe return light not detected",7:"Strobe return light detected",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},SensingMethod:{1:"Not defined",2:"One-chip color area sensor",3:"Two-chip color area sensor",4:"Three-chip color area sensor",5:"Color sequential area sensor",7:"Trilinear sensor",8:"Color sequential linear sensor"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},SceneType:{1:"Directly photographed"},CustomRendered:{0:"Normal process",1:"Custom process"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},GainControl:{0:"None",1:"Low gain up",2:"High gain up",3:"Low gain down",4:"High gain down"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},SubjectDistanceRange:{0:"Unknown",1:"Macro",2:"Close view",3:"Distant view"},FileSource:{3:"DSC"},Components:{0:"",1:"Y",2:"Cb",3:"Cr",4:"R",5:"G",6:"B"}};function h(n,p,o){if(n.addEventListener){n.addEventListener(p,o,false)}else{if(n.attachEvent){n.attachEvent("on"+p,o)}}}function g(n){return !!(n.exifdata)}function i(o,n){c(o.src,function(p){console.log("BINARY",p.binaryResponse);var q=d(p.binaryResponse);o.exifdata=q||{};if(n){n()}})}function e(p,n){var r=atob(p.src.split(",")[1]);var q=new b(r,0,r.length);var o=d(q);p.exifdata=o||{};if(n){n()}}function d(q){var n=[];if(q.getByteAt(0)!=255||q.getByteAt(1)!=216){return false}var p=2;var o=q.getLength();while(p<o){if(q.getByteAt(p)!=255){if(l){console.log("Not a valid marker at offset "+p+", found: "+q.getByteAt(p))}return false}var r=q.getByteAt(p+1);if(r==22400){if(l){console.log("Found 0xFFE1 marker")}return k(q,p+4,q.getShortAt(p+2,true)-2);p+=2+q.getShortAt(p+2,true)}else{if(r==225){if(l){console.log("Found 0xFFE1 marker")}return k(q,p+4,q.getShortAt(p+2,true)-2)}else{p+=2+q.getShortAt(p+2,true)}}}}function j(u,r,w,o,t){var n=u.getShortAt(w,t);var s={};for(var p=0;p<n;p++){var v=w+p*12+2;var q=o[u.getShortAt(v,t)];if(!q&&l){console.log("Unknown tag: "+u.getShortAt(v,t))}s[q]=f(u,v,r,w,t)}return s}function f(x,z,s,y,u){var v=x.getShortAt(z+2,u);var w=x.getLongAt(z+4,u);var q=x.getLongAt(z+8,u)+s;switch(v){case 1:case 7:if(w==1){return x.getByteAt(z+8,u)}else{var o=w>4?q:(z+8);var t=[];for(var p=0;p<w;p++){t[p]=x.getByteAt(o+p)}return t}break;case 2:var r=w>4?q:(z+8);return x.getStringAt(r,w-1);break;case 3:if(w==1){return x.getShortAt(z+8,u)}else{var o=w>2?q:(z+8);var t=[];for(var p=0;p<w;p++){t[p]=x.getShortAt(o+2*p,u)}return t}break;case 4:if(w==1){return x.getLongAt(z+8,u)}else{var t=[];for(var p=0;p<w;p++){t[p]=x.getLongAt(q+4*p,u)}return t}break;case 5:if(w==1){return x.getLongAt(q,u)/x.getLongAt(q+4,u)}else{var t=[];for(var p=0;p<w;p++){t[p]=x.getLongAt(q+8*p,u)/x.getLongAt(q+4+8*p,u)}return t}break;case 9:if(w==1){return x.getSLongAt(z+8,u)}else{var t=[];for(var p=0;p<w;p++){t[p]=x.getSLongAt(q+4*p,u)}return t}break;case 10:if(w==1){return x.getSLongAt(q,u)/x.getSLongAt(q+4,u)}else{var t=[];for(var p=0;p<w;p++){t[p]=x.getSLongAt(q+8*p,u)/x.getSLongAt(q+4+8*p,u)}return t}break}}function k(v,n,p){if(v.getStringAt(n,4)!="Exif"){if(l){console.log("Not valid EXIF data! "+v.getStringAt(n,4))}return false}var t;var q=n+6;if(v.getShortAt(q)==18761){t=false}else{if(v.getShortAt(q)==19789){t=true}else{if(l){console.log("Not valid TIFF data! (no 0x4949 or 0x4D4D)")}return false}}if(v.getShortAt(q+2,t)!=42){if(l){console.log("Not valid TIFF data! (no 0x002A)")}return false}if(v.getLongAt(q+4,t)!=8){if(l){console.log("Not valid TIFF data! (First offset not 8)",v.getShortAt(q+4,t))}return false}var s=j(v,q,q+8,a.TiffTags,t);if(s.ExifIFDPointer){var u=j(v,q,q+s.ExifIFDPointer,a.Tags,t);for(var r in u){switch(r){case"LightSource":case"Flash":case"MeteringMode":case"ExposureProgram":case"SensingMethod":case"SceneCaptureType":case"SceneType":case"CustomRendered":case"WhiteBalance":case"GainControl":case"Contrast":case"Saturation":case"Sharpness":case"SubjectDistanceRange":case"FileSource":u[r]=a.StringValues[r][u[r]];break;case"ExifVersion":case"FlashpixVersion":u[r]=String.fromCharCode(u[r][0],u[r][1],u[r][2],u[r][3]);break;case"ComponentsConfiguration":u[r]=a.StringValues.Components[u[r][0]]+a.StringValues.Components[u[r][1]]+a.StringValues.Components[u[r][2]]+a.StringValues.Components[u[r][3]];break}s[r]=u[r]}}if(s.GPSInfoIFDPointer){var o=j(v,q,q+s.GPSInfoIFDPointer,a.GPSTags,t);for(var r in o){switch(r){case"GPSVersionID":o[r]=o[r][0]+"."+o[r][1]+"."+o[r][2]+"."+o[r][3];break}s[r]=o[r]}}return s}a.getData=function(o,n){if(!o.complete){return false}if(!g(o)){i(o,n)}else{if(n){n()}}return true};a.getDataFromDataURL=function(o,n){if(!o.complete){return false}if(!g(o)){e(o,n)}else{if(n){n()}}return true};a.getTag=function(o,n){if(!g(o)){return}return o.exifdata[n]};a.getAllTags=function(p){if(!g(p)){return{}}var q=p.exifdata;var o={};for(var n in q){if(q.hasOwnProperty(n)){o[n]=q[n]}}return o};a.pretty=function(p){if(!g(p)){return""}var q=p.exifdata;var o="";for(var n in q){if(q.hasOwnProperty(n)){if(typeof q[n]=="object"){o+=n+" : ["+q[n].length+" values]\r\n"}else{o+=n+" : "+q[n]+"\r\n"}}}return o};a.readFromBinaryFile=function(n){return d(n)};function m(){var o=document.getElementsByTagName("img");for(var n=0;n<o.length;n++){if(o[n].getAttribute("exif")=="true"){if(!o[n].complete){h(o[n],"load",function(){a.getData(this)})}else{a.getData(o[n])}}}}jQuery(document).ready(m);jQuery.fn.exifLoad=function(n){return this.each(function(){a.getData(this,n)})};jQuery.fn.exifLoadFromDataURL=function(n){return this.each(function(){a.getDataFromDataURL(this,n);return true})};jQuery.fn.exif=function(o){var n=[];this.each(function(){n.push(a.getTag(this,o))});return n};jQuery.fn.exifAll=function(){var n=[];this.each(function(){n.push(a.getAllTags(this))});return n};jQuery.fn.exifPretty=function(){var n=[];this.each(function(){n.push(a.pretty(this))});return n}})()})();